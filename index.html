<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>ü¶ú TalkaTuka</title>

    <!-- Firebase (compat SDKs) -->
    <script src="https://www.gstatic.com/firebasejs/10.11.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.11.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.11.0/firebase-database-compat.js"></script>

    <style>
        :root {
            --primary: #00D4FF;
            --primary-dark: #0A9BC1;
            --header: #0F1419;
            --bg: #0D0F14;
            --card: #1A1E27;
            --card-light: #242933;
            --text-primary: #FFFFFF;
            --text-secondary: #A0A8B5;
            --accent-cyan: #00D4FF;
            --accent-purple: #8B5CF6;
            --accent-pink: #EC4899;
            --success: #10B981;
        }

        * {
            box-sizing: border-box
        }

        html,
        body {
            height: 100%;
            margin: 0;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', 'Helvetica Neue', sans-serif;
            background: var(--bg);
            color: var(--text-primary);
        }

        .app {
            width: 420px;
            max-width: 100%;
            height: 100vh;
            margin: 0 auto;
            display: flex;
            flex-direction: column;
            border-left: 1px solid rgba(0, 212, 255, 0.1);
            border-right: 1px solid rgba(0, 212, 255, 0.1);
            background: linear-gradient(135deg, #0F1419 0%, #1A1E27 100%);
        }

        /* header */
        header.app-header {
            height: auto;
            background: linear-gradient(90deg, #0F1419 0%, #1A1E27 100%);
            color: white;
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 16px 18px;
            justify-content: center;
            border-bottom: 1px solid rgba(0, 212, 255, 0.1);
            backdrop-filter: blur(10px);
        }

        header h1 {
            font-size: 24px;
            margin: 0 0 4px 0;
            font-weight: 800;
            letter-spacing: -0.5px;
            background: linear-gradient(90deg, #00D4FF, #8B5CF6);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .text-btn {
            background: linear-gradient(135deg, #00D4FF 0%, #8B5CF6 100%);
            border: 0;
            color: #FFFFFF;
            padding: 10px 16px;
            border-radius: 10px;
            cursor: pointer;
            font-weight: 700;
            font-size: 11px;
            transition: all 0.3s ease;
            box-shadow: 0 4px 12px rgba(0, 212, 255, 0.25);
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .text-btn:hover {
            transform: translateY(-3px);
            box-shadow: 0 6px 20px rgba(0, 212, 255, 0.4);
        }

        .text-btn:active {
            transform: translateY(-1px);
        }

        /* tabs */
        .tabbar {
            display: flex;
            gap: 8px;
            padding: 12px 18px;
            background: transparent;
            border-bottom: 1px solid rgba(0, 212, 255, 0.05);
        }

        .tab {
            padding: 8px 14px;
            border-radius: 8px;
            font-weight: 600;
            color: var(--accent-cyan);
            background: rgba(0, 212, 255, 0.08);
            font-size: 13px;
        }

        .main {
            display: flex;
            flex: 1;
            overflow: hidden;
            position: relative;
        }

        .chats-panel {
            width: 100%;
            flex: 1;
            display: flex;
            flex-direction: column;
            border-right: none;
            background: transparent;
            min-width: 0;
            position: relative;
            z-index: 1;
        }

        .search {
            padding: 12px 18px;
        }

        .search input {
            width: 100%;
            padding: 12px 16px;
            border-radius: 12px;
            border: 1px solid rgba(0, 212, 255, 0.15);
            background: var(--card);
            color: var(--text-primary);
            font-size: 14px;
            transition: all 0.3s ease;
        }

        .search input:focus {
            outline: none;
            border-color: var(--accent-cyan);
            background: var(--card-light);
            box-shadow: 0 0 12px rgba(0, 212, 255, 0.15);
        }

        .search input::placeholder {
            color: var(--text-secondary);
        }

        .list {
            flex: 1;
            overflow: auto;
            padding: 8px 12px;
        }

        .list::-webkit-scrollbar {
            width: 6px;
        }

        .list::-webkit-scrollbar-track {
            background: transparent;
        }

        .list::-webkit-scrollbar-thumb {
            background: rgba(0, 212, 255, 0.2);
            border-radius: 3px;
        }

        .list::-webkit-scrollbar-thumb:hover {
            background: rgba(0, 212, 255, 0.4);
        }

        .chat-item {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 14px;
            border-radius: 14px;
            margin-bottom: 8px;
            background: var(--card);
            cursor: pointer;
            transition: all 0.3s ease;
            border: 1px solid rgba(0, 212, 255, 0.05);
        }

        .chat-item:hover {
            background: var(--card-light);
            border-color: rgba(0, 212, 255, 0.2);
            transform: translateX(4px);
        }

        .avatar {
            width: 56px;
            height: 56px;
            border-radius: 12px;
            background: linear-gradient(135deg, #00D4FF, #8B5CF6);
            flex-shrink: 0;
            display: flex;
            align-items: center;
            justify-content: center;
            overflow: hidden;
            position: relative;
        }

        .avatar::before {
            content: '';
            position: absolute;
            inset: 0;
            background: rgba(0, 0, 0, 0.1);
        }

        .chat-meta {
            flex: 1;
            min-width: 0
        }

        .chat-meta .head {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 6px;
        }

        .chat-meta .name {
            font-weight: 700;
            font-size: 15px;
            white-space: nowrap;
            text-overflow: ellipsis;
            overflow: hidden
        }

        .chat-meta .preview {
            color: var(--text-secondary);
            font-size: 13px;
            white-space: nowrap;
            text-overflow: ellipsis;
            overflow: hidden
        }

        .time-badge {
            font-size: 12px;
            color: var(--text-secondary);
        }

        .unread-badge {
            background: linear-gradient(135deg, var(--accent-cyan), var(--accent-purple));
            color: white;
            padding: 4px 8px;
            border-radius: 6px;
            font-size: 11px;
            font-weight: 700;
            margin-left: 8px;
            min-width: 20px;
            text-align: center;
        }

        .chat-panel {
            flex: 1;
            display: none;
            flex-direction: column;
            background: linear-gradient(135deg, #0F1419 0%, #1A1E27 100%);
            min-width: 0;
            position: absolute;
            inset: 0;
            z-index: 10;
        }

        .chat-panel.active {
            display: flex;
        }

        .chat-header {
            height: 64px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 12px 18px;
            border-bottom: 1px solid rgba(0, 212, 255, 0.1);
            background: rgba(15, 20, 25, 0.8);
            backdrop-filter: blur(10px);
        }

        .chat-header .name {
            font-weight: 700;
            display: flex;
            align-items: center;
            gap: 8px
        }

        .chat-body {
            flex: 1;
            padding: 16px 18px;
            display: flex;
            flex-direction: column;
            gap: 12px;
            overflow: auto;
            align-items: flex-start
        }

        .chat-body::-webkit-scrollbar {
            width: 6px;
        }

        .chat-body::-webkit-scrollbar-track {
            background: transparent;
        }

        .chat-body::-webkit-scrollbar-thumb {
            background: rgba(0, 212, 255, 0.2);
            border-radius: 3px;
        }

        .bubble {
            padding: 12px 16px;
            border-radius: 16px;
            max-width: 78%;
            position: relative;
            word-break: break-word;
            font-size: 14px;
        }

        .bubble.sent {
            margin-left: auto;
            background: linear-gradient(135deg, #00D4FF, #0A9BC1);
            color: #000;
            border-radius: 16px 4px 16px 16px;
        }

        .bubble.recv {
            margin-right: auto;
            background: var(--card-light);
            color: var(--text-primary);
            border: 1px solid rgba(0, 212, 255, 0.1);
            border-radius: 4px 16px 16px 16px;
        }

        .bubble .time {
            display: block;
            font-size: 11px;
            color: var(--text-secondary);
            margin-top: 6px;
            text-align: right
        }

        .bubble.recv .time {
            text-align: left;
        }

        .bubble .ticks {
            font-size: 12px;
            color: var(--text-secondary);
            margin-left: 6px
        }

        .chat-input {
            display: flex;
            align-items: center;
            padding: 14px 18px;
            border-top: 1px solid rgba(0, 212, 255, 0.1);
            background: rgba(15, 20, 25, 0.8);
            gap: 10px;
            backdrop-filter: blur(10px);
        }

        .chat-input input {
            flex: 1;
            padding: 12px 16px;
            border-radius: 12px;
            border: 1px solid rgba(0, 212, 255, 0.15);
            background: var(--card);
            color: var(--text-primary);
            font-size: 14px;
            transition: all 0.3s ease;
        }

        .chat-input input:focus {
            outline: none;
            border-color: var(--accent-cyan);
            background: var(--card-light);
            box-shadow: 0 0 12px rgba(0, 212, 255, 0.1);
        }

        .chat-input input::placeholder {
            color: var(--text-secondary);
        }

        .fab {
            width: 44px;
            height: 44px;
            border-radius: 10px;
            background: linear-gradient(135deg, var(--accent-cyan), var(--accent-purple));
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: 700;
            border: none;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 18px;
            background-image: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="white"><path d="M16.6915026,12.4744748 L3.50612381,13.2599618 C3.19218622,13.2599618 3.03521743,13.4170592 3.03521743,13.5741566 L1.15159189,20.0151496 C0.8376543,20.8006365 0.99,21.89 1.77946707,22.52 C2.41,22.99 3.50612381,23.1 4.13399899,22.8429026 L21.714504,14.0454487 C22.6563168,13.5741566 23.1272231,12.6315722 22.9702544,11.6889879 L4.13399899,1.16398446 C3.34915502,0.9 2.40734225,0.9 1.77946707,1.42603414 C0.994623095,2.05474348 0.837654326,3.01739898 1.15159189,3.80288585 L3.03521743,10.4137953 C3.03521743,10.5709374 3.19218622,10.7280635 3.50612381,10.7280635 L16.6915026,11.5135503 C16.6915026,11.5135503 17.1624089,11.5135503 17.1624089,12.0394845 C17.1624089,12.5654186 16.6915026,12.4744748 16.6915026,12.4744748 Z"/></svg>');
            background-size: 60%;
            background-repeat: no-repeat;
            background-position: center;
            color: transparent;
        }

        .fab:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 16px rgba(0, 212, 255, 0.3);
        }

        .fab:active {
            transform: translateY(0);
        }

        .bottom-nav {
            height: 60px;
            background: rgba(26, 30, 39, 0.8);
            border-top: 1px solid rgba(0, 212, 255, 0.1);
            display: flex;
            align-items: center;
            justify-content: space-around;
            order: 1;
            backdrop-filter: blur(10px);
        }

        .bottom-nav button {
            background: rgba(0, 212, 255, 0.1);
            border: 1px solid rgba(0, 212, 255, 0.2);
            cursor: pointer;
            padding: 10px 16px;
            border-radius: 10px;
            font-weight: 700;
            color: var(--accent-cyan);
            font-size: 11px;
            letter-spacing: 0.5px;
            transition: all 0.3s ease;
            text-transform: uppercase;
        }

        .bottom-nav button:hover {
            background: rgba(0, 212, 255, 0.15);
            border-color: rgba(0, 212, 255, 0.4);
            transform: translateY(-1px);
        }

        .bottom-nav button:active {
            transform: translateY(0);
        }

        @media (max-width:700px) {
            .app {
                width: 100%
            }

            .main {
                flex-direction: column
            }

            .chat-panel.active {
                display: flex
            }
        }

        .centered {
            display: flex;
            justify-content: center;
            align-items: center
        }

        .hidden {
            display: none
        }

        /* toasts */
        .toast-holder {
            position: fixed;
            left: 50%;
            transform: translateX(-50%);
            bottom: 80px;
            display: flex;
            flex-direction: column;
            gap: 8px;
            z-index: 2000;
            pointer-events: none
        }

        .toast {
            min-width: 160px;
            max-width: 90vw;
            padding: 12px 16px;
            border-radius: 10px;
            background: rgba(26, 30, 39, 0.95);
            color: white;
            opacity: 0;
            transform: translateY(10px);
            transition: all .28s;
            pointer-events: auto;
            border: 1px solid rgba(0, 212, 255, 0.2);
            backdrop-filter: blur(10px);
        }

        .toast.show {
            opacity: 1;
            transform: translateY(0)
        }

        .toast.success {
            background: rgba(16, 185, 129, 0.2);
            border-color: rgba(16, 185, 129, 0.4);
            color: var(--success);
        }

        .toast.info {
            background: rgba(0, 212, 255, 0.2);
            border-color: rgba(0, 212, 255, 0.4);
        }

        /* modals */
        .modal-backdrop {
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, 0.6);
            backdrop-filter: blur(4px);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1500
        }

        .modal {
            width: 92%;
            max-width: 400px;
            background: linear-gradient(135deg, #1A1E27 0%, #242933 100%);
            padding: 24px;
            border-radius: 16px;
            box-shadow: 0 24px 48px rgba(0, 0, 0, 0.4);
            border: 1px solid rgba(0, 212, 255, 0.1);
        }

        .modal input {
            width: 100%;
            padding: 12px 16px;
            border-radius: 10px;
            border: 1px solid rgba(0, 212, 255, 0.15);
            background: var(--card);
            color: var(--text-primary);
            margin-top: 12px;
            font-size: 14px;
            transition: all 0.3s ease;
        }

        .modal input:focus {
            outline: none;
            border-color: var(--accent-cyan);
            box-shadow: 0 0 12px rgba(0, 212, 255, 0.15);
        }

        .modal input::placeholder {
            color: var(--text-secondary);
        }

        .modal .row {
            display: flex;
            gap: 10px;
            margin-top: 16px
        }

        .btn {
            padding: 12px 16px;
            border-radius: 10px;
            border: 0;
            cursor: pointer;
            font-weight: 700;
            font-size: 14px;
            transition: all 0.3s ease;
        }

        .btn.ghost {
            background: rgba(0, 212, 255, 0.1);
            border: 1px solid rgba(0, 212, 255, 0.2);
            color: var(--accent-cyan);
        }

        .btn.ghost:hover {
            background: rgba(0, 212, 255, 0.15);
            border-color: rgba(0, 212, 255, 0.4);
        }

        .btn.primary {
            background: linear-gradient(135deg, var(--accent-cyan), var(--accent-purple));
            color: white;
            box-shadow: 0 4px 12px rgba(0, 212, 255, 0.25);
        }

        .btn.primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 16px rgba(0, 212, 255, 0.35);
        }

        .back-btn {
            margin-right: 12px;
            cursor: pointer;
            font-size: 24px;
            color: var(--accent-cyan);
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            width: 36px;
            height: 36px;
            border-radius: 8px;
            background: rgba(0, 212, 255, 0.1);
            border: 1px solid rgba(0, 212, 255, 0.2);
        }

        .back-btn:hover {
            background: rgba(0, 212, 255, 0.15);
            border-color: rgba(0, 212, 255, 0.4);
            transform: translateX(-2px);
        }

        /* splash screen */
        .splash-screen {
            position: fixed;
            inset: 0;
            background: linear-gradient(135deg, #0F1419 0%, #1A1E27 100%);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            z-index: 9999;
            opacity: 1;
            transition: opacity 0.5s ease;
        }

        .splash-screen.hidden {
            opacity: 0;
            pointer-events: none;
        }

        .splash-content {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 24px;
        }

        .splash-image {
            width: 120px;
            height: 120px;
            border-radius: 20px;
            background: linear-gradient(135deg, #00D4FF, #8B5CF6);
            display: flex;
            align-items: center;
            justify-content: center;
            overflow: hidden;
            animation: pulse 2s ease-in-out infinite;
        }

        .splash-image img {
            width: 100%;
            height: 100%;
            object-fit: cover;
            border-radius: 20px;
        }

        .splash-text {
            font-size: 20px;
            font-weight: 700;
            text-align: center;
            background: linear-gradient(90deg, #00D4FF, #8B5CF6);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        @keyframes pulse {

            0%,
            100% {
                transform: scale(1);
            }

            50% {
                transform: scale(1.05);
            }
        }

        /* Call UI */
        .call-button {
            width: 40px;
            height: 40px;
            border-radius: 8px;
            background: rgba(16, 185, 129, 0.15);
            border: 1px solid rgba(16, 185, 129, 0.3);
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--success);
            font-weight: 700;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 18px;
            flex-shrink: 0;
        }

        .call-button:hover {
            background: rgba(16, 185, 129, 0.3);
            border-color: rgba(16, 185, 129, 0.5);
            transform: scale(1.05);
        }

        .call-button:active {
            transform: scale(0.95);
        }

        /* Incoming call modal */
        .incoming-call-modal {
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, 0.8);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 2000;
        }

        .incoming-call-modal.show {
            display: flex;
        }

        .incoming-call-content {
            background: linear-gradient(135deg, #1A1E27 0%, #242933 100%);
            padding: 40px;
            border-radius: 20px;
            text-align: center;
            border: 1px solid rgba(0, 212, 255, 0.1);
        }

        .incoming-call-content h3 {
            font-size: 20px;
            margin: 0 0 8px 0;
        }

        .incoming-call-content p {
            color: var(--text-secondary);
            margin: 0 0 24px 0;
        }

        .call-actions {
            display: flex;
            gap: 12px;
            justify-content: center;
        }

        .call-btn {
            width: 60px;
            height: 60px;
            border-radius: 50%;
            border: none;
            cursor: pointer;
            font-weight: 700;
            font-size: 24px;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .call-btn-accept {
            background: var(--success);
            color: white;
        }

        .call-btn-accept:hover {
            transform: scale(1.1);
            box-shadow: 0 0 20px rgba(16, 185, 129, 0.5);
        }

        .call-btn-reject {
            background: #ef4444;
            color: white;
        }

        .call-btn-reject:hover {
            transform: scale(1.1);
            box-shadow: 0 0 20px rgba(239, 68, 68, 0.5);
        }

        /* In-call overlay */
        .in-call-overlay {
            position: fixed;
            inset: 0;
            background: #000;
            display: none;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            z-index: 2500;
        }

        .in-call-overlay.show {
            display: flex;
        }

        .in-call-video-container {
            width: 100%;
            height: 100%;
            display: flex;
            align-items: center;
            justify-content: center;
            position: relative;
            background: #000;
        }

        .in-call-bg {
            width: 100%;
            height: 100%;
            background-image: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="100" height="100"><defs><pattern id="grid" width="20" height="20" patternUnits="userSpaceOnUse"><path d="M 20 0 L 0 0 0 20" fill="none" stroke="%23222" stroke-width="1"/></pattern></defs><rect width="100%" height="100%" fill="%23111"/><rect width="100%" height="100%" fill="url(%23grid)"/></svg>');
            background-size: 100px 100px;
            background-repeat: repeat;
            background-color: #0a0e12;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            position: relative;
        }

        .in-call-bg::before {
            content: '';
            position: absolute;
            inset: 0;
            background: rgba(0, 0, 0, 0.3);
            backdrop-filter: blur(1px);
        }

        .in-call-profile {
            width: 120px;
            height: 120px;
            border-radius: 50%;
            background: linear-gradient(135deg, #00D4FF, #8B5CF6);
            padding: 3px;
            margin-bottom: 20px;
            position: relative;
            z-index: 2;
        }

        .in-call-profile img {
            width: 100%;
            height: 100%;
            border-radius: 50%;
            object-fit: cover;
        }

        .in-call-user-info {
            text-align: center;
            color: white;
            position: relative;
            z-index: 2;
        }

        .in-call-user-info h2 {
            font-size: 24px;
            margin: 0 0 8px 0;
            font-weight: 700;
        }

        .in-call-user-info p {
            font-size: 14px;
            color: #aaa;
            margin: 0;
        }

        .in-call-video-container video {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .in-call-controls {
            position: absolute;
            bottom: 40px;
            display: flex;
            gap: 20px;
            z-index: 2501;
        }

        .in-call-control-btn {
            width: 60px;
            height: 60px;
            border-radius: 50%;
            background: rgba(26, 30, 39, 0.85);
            border: 2px solid rgba(0, 212, 255, 0.3);
            color: white;
            cursor: pointer;
            font-size: 24px;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s ease;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.5);
        }

        .in-call-control-btn:hover {
            background: rgba(26, 30, 39, 1);
            border-color: rgba(0, 212, 255, 0.6);
            transform: scale(1.1);
        }

        .in-call-end-btn {
            background: #ef4444;
            border-color: #dc2626;
        }

        .in-call-end-btn:hover {
            background: #dc2626;
            transform: scale(1.1);
        }

        .in-call-end-btn:hover {
            background: #dc2626;
        }

        .in-call-info {
            position: absolute;
            top: 20px;
            left: 20px;
            color: white;
            font-size: 14px;
            background: rgba(26, 30, 39, 0.9);
            padding: 12px 16px;
            border-radius: 10px;
        }
    </style>
</head>

<body>
    <div class="app" id="appRoot">
        <!-- Splash Screen -->
        <div class="splash-screen" id="splashScreen">
            <div class="splash-content">
                <div class="splash-image">
                    <img src="https://img.freepik.com/free-vector/cute-parrot-bird-branch-cartoon-vector-icon-illustration-animal-nature-icon-isolated-flat-vector_138676-14867.jpg?w=740&q=80"
                        alt="MiniChat">
                </div>
                <div class="splash-text">ü¶ú Warming up the wings‚Ä¶</div>
            </div>
        </div>

        <header class="app-header">
            <div
                style="display: flex; align-items: flex-start; justify-content: center; width: 100%; flex-direction: column; gap: 4px;">
                <h1 id="appTitle">ü¶ú TalkaTuka</h1>
                <div style="font-size: 12px; color: var(--text-secondary); text-align: center; width: 100%;">Chats</div>
            </div>
        </header>

        <div class="bottom-nav">
            <button onclick="openChats()">CHATS</button>
            <button onclick="openAddFriendModal()">ADD FRIEND</button>
            <button id="bottomSettingsBtn" onclick="openSettingsModal()">SETTINGS</button>
            <button onclick="openMore()">MORE</button>
        </div>

        <div class="main">
            <div class="chats-panel" id="chatsPanel">
                <div class="search">
                    <input id="searchInput" placeholder="Search or start new chat" oninput="filterChats()" />
                </div>
                <div class="list" id="chatList"></div>
            </div>

            <div class="chat-panel" id="chatPanel">
                <div class="chat-header">
                    <div style="display:flex;align-items:center;gap:12px;flex:1">
                        <div class="back-btn" id="backBtn" onclick="backToChats()" style="display:none">‚Üê</div>
                        <div class="avatar"><img id="chatAvatar"
                                src="https://img.freepik.com/free-vector/cute-parrot-bird-branch-cartoon-vector-icon-illustration-animal-nature-icon-isolated-flat-vector_138676-14867.jpg?w=740&q=80"
                                style="width:40px;height:40px;border-radius:50%;object-fit:cover"></div>
                        <div>
                            <div class="name" id="chatName">Select a chat</div>
                            <div class="status" id="chatStatus" style="font-size:13px;color:#666">Offline</div>
                        </div>
                    </div>
                    <button class="call-button" id="callBtn" onclick="initiateCall()" title="Start call">üìû</button>
                </div>

                <div class="chat-body" id="chatBody"></div>

                <div class="chat-input">
                    <input id="messageInput" placeholder="Message" oninput="typing(true)"
                        onkeypress="if(event.key==='Enter') sendMessage()" />
                    <button class="fab" onclick="sendMessage()">Send</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Auth modal (centered) -->
    <div id="authModal" class="centered" style="position:fixed;inset:0;background:rgba(0,0,0,0.15);z-index:999;">
        <div id="authCard"
            style="width:92%;max-width:360px;background:var(--card);padding:20px;border-radius:12px;box-shadow:0 20px 40px rgba(0,0,0,0.12)">
            <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:10px">
                <strong style="font-size:18px">ü¶ú TalkaTuka</strong>
            </div>

            <div style="display:flex;gap:8px;margin-bottom:8px">
                <button id="showLoginBtn" class="btn primary" style="flex:1">Login</button>
                <button id="showSignupBtn" class="btn ghost" style="flex:1">Signup</button>
            </div>

            <div id="loginForm">
                <input id="loginEmail" type="email" placeholder="Email" />
                <input id="loginPass" type="password" placeholder="Password" />
                <div style="display:flex;gap:8px;margin-top:8px">
                    <button class="btn primary" style="flex:1" onclick="login()">Continue</button>
                    <button class="btn ghost" style="flex:1" onclick="clearLogin()">Clear</button>
                </div>
                <div id="loginErr" style="color:#c0392b;margin-top:8px;min-height:20px"></div>
            </div>

            <div id="signupForm" style="display:none">
                <input id="signupName" placeholder="Full name" />
                <input id="signupEmail" type="email" placeholder="Email" />
                <input id="signupPass" type="password" placeholder="Password" />
                <div style="display:flex;gap:8px;margin-top:8px">
                    <button class="btn primary" style="flex:1" onclick="signup()">Create</button>
                    <button class="btn ghost" style="flex:1" onclick="cancelSignup()">Cancel</button>
                </div>
                <div id="signupErr" style="color:#c0392b;margin-top:8px;min-height:20px"></div>
            </div>
        </div>
    </div>

    <!-- Add Friend Modal -->
    <div id="addFriendModal" class="modal-backdrop hidden">
        <div class="modal">
            <h3>Add friend</h3>
            <div style="font-size:13px;color:#666">Type the email of the user you want to add (must be registered)</div>
            <input id="addFriendEmail" placeholder="friend@example.com" />
            <div class="row">
                <button class="btn ghost" onclick="closeAddFriendModal()">Cancel</button>
                <button class="btn primary" onclick="addFriendFromModal()">Add</button>
            </div>
            <div id="addFriendErr" style="color:#c0392b;margin-top:8px;min-height:18px"></div>
        </div>
    </div>

    <!-- Settings Modal (no upload) -->
    <div id="settingsModal" class="modal-backdrop hidden">
        <div class="modal">
            <h3>Settings</h3>
            <div style="font-size:13px;color:#666;margin-bottom:8px">Change display name</div>
            <input id="changeNameInput" placeholder="New display name" />
            <div style="display:flex;gap:8px;margin-top:12px">
                <button class="btn ghost" onclick="closeSettingsModal()">Close</button>
                <button class="btn primary" onclick="updateDisplayName()">Save</button>
            </div>
            <div id="settingsMsg" style="color:#c0392b;margin-top:8px;min-height:18px"></div>
        </div>
    </div>

    <!-- More Modal -->
    <div id="moreModal" class="modal-backdrop hidden">
        <div class="modal">
            <h3>Account</h3>
            <div style="display:flex;flex-direction:column;gap:8px;margin-top:10px">
                <button class="btn ghost" onclick="switchAccountModal()">Switch account</button>
                <button class="btn ghost" onclick="logoutFromModal()">Logout</button>
                <button class="btn ghost" onclick="closeMoreModal()">Close</button>
            </div>
        </div>
    </div>

    <!-- Toast holder -->
    <div class="toast-holder" id="toastHolder"></div>

    <!-- Incoming call modal -->
    <div class="incoming-call-modal" id="incomingCallModal">
        <div class="incoming-call-content">
            <h3>Incoming Call</h3>
            <p id="incomingCallerName">Someone is calling...</p>
            <div class="call-actions">
                <button class="call-btn call-btn-accept" onclick="acceptCall()">‚úì</button>
                <button class="call-btn call-btn-reject" onclick="rejectCall()">‚úï</button>
            </div>
        </div>
    </div>

    <!-- In-call overlay -->
    <div class="in-call-overlay" id="inCallOverlay">
        <div class="in-call-video-container">
            <div class="in-call-bg">
                <div class="in-call-profile">
                    <img id="callUserAvatar"
                        src="https://img.freepik.com/free-vector/cute-parrot-bird-branch-cartoon-vector-icon-illustration-animal-nature-icon-isolated-flat-vector_138676-14867.jpg?w=740&q=80"
                        alt="User">
                </div>
                <div class="in-call-user-info">
                    <h2 id="callUserName">User</h2>
                    <p id="callStatus">Connecting...</p>
                </div>
            </div>
            <video id="localVideo" autoplay muted playsinline style="display:none;"></video>
            <div class="in-call-controls">
                <button class="in-call-control-btn" id="muteBtn" onclick="toggleMute()" title="Mute/Unmute">üîä</button>
                <button class="in-call-control-btn in-call-end-btn" onclick="endCall()" title="End call">‚òé</button>
            </div>
        </div>
    </div>

    <script>
        /* -------------------- Firebase init -------------------- */
        const firebaseConfig = {
            apiKey: "AIzaSyC3W8qNs05jL3DFZPyZUQl4auF6_h3XDuM",
            authDomain: "minichat-4396e.firebaseapp.com",
            databaseURL: "https://minichat-4396e-default-rtdb.firebaseio.com",
            projectId: "minichat-4396e",
            storageBucket: "minichat-4396e.firebasestorage.app",
            messagingSenderId: "266306645242",
            appId: "1:266306645242:web:ecdec5772c4a9ae31f6d43"
        };
        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const db = firebase.database();

        /* -------------------- State -------------------- */
        let currentUser = null;
        let activeChatId = null;
        let activeFriendUid = null;
        let typingTimer = null;
        let friendNames = {}; // cache friend names for notifications

        // Call state
        let localStream = null;
        let peerConnection = null;
        let inCall = false;
        let callInProgress = false;
        let incomingCallData = null;
        let callStartTime = null;
        let callDurationInterval = null;
        let currentCallId = null;
        let processedCallIds = new Set(); // Track which calls we've already shown

        /* -------------------- Helpers -------------------- */
        function $(id) { return document.getElementById(id); }
        function show(el) { if (!el) return; el.classList.remove('hidden'); el.style.display = ''; }
        function hide(el) { if (!el) return; el.classList.add('hidden'); el.style.display = 'none'; }

        /* Request notification permission */
        function requestNotificationPermission() {
            if ('Notification' in window && Notification.permission === 'default') {
                Notification.requestPermission();
            }
        }

        /* Send notification */
        function sendNotification(title, options = {}) {
            if ('Notification' in window && Notification.permission === 'granted') {
                new Notification(title, {
                    icon: 'https://img.freepik.com/free-vector/cute-parrot-bird-branch-cartoon-vector-icon-illustration-animal-nature-icon-isolated-flat-vector_138676-14867.jpg?w=740&q=80',
                    badge: 'https://img.freepik.com/free-vector/cute-parrot-bird-branch-cartoon-vector-icon-illustration-animal-nature-icon-isolated-flat-vector_138676-14867.jpg?w=740&q=80',
                    ...options
                });
            }
        }

        /* -------------------- WebRTC Calling -------------------- */
        const ICE_SERVERS = { iceServers: [{ urls: ['stun:stun.l.google.com:19302', 'stun:stun1.l.google.com:19302'] }] };

        async function initiateCall() {
            if (!activeFriendUid) return showToast('Select a chat first', 'info');
            if (callInProgress) return showToast('Call already in progress', 'info');

            try {
                callInProgress = true;
                const callId = [currentUser.uid, activeFriendUid].sort().join('_') + '_' + Date.now();

                // Request media
                localStream = await navigator.mediaDevices.getUserMedia({ audio: true, video: false });

                // Send call offer
                const offer = await createOffer(callId);
                db.ref('calls/' + callId).set({
                    caller: currentUser.uid,
                    callee: activeFriendUid,
                    offer: JSON.stringify(offer),
                    status: 'ringing',
                    timestamp: Date.now()
                });

                // Show calling screen immediately
                $('inCallOverlay').classList.add('show');
                $('callUserName').textContent = friendNames[activeFriendUid] || 'User';
                $('callStatus').textContent = 'Calling...';

                // Listen for answer
                let answered = false;
                db.ref('calls/' + callId + '/answer').on('value', async (snap) => {
                    if (!answered && snap.val()) {
                        answered = true;
                        try {
                            const answer = JSON.parse(snap.val());
                            await peerConnection.setRemoteDescription(new RTCSessionDescription(answer));
                            startCall(callId);
                            showToast('Call connected', 'success', 1200);
                        } catch (e) {
                            console.error('Error setting remote description:', e);
                        }
                    }
                });

                // Listen for ICE candidates from remote
                db.ref('calls/' + callId + '/iceCandidates/' + activeFriendUid).on('child_added', (snap) => {
                    if (peerConnection && snap.val()) {
                        try {
                            const candidate = JSON.parse(snap.val());
                            peerConnection.addIceCandidate(new RTCIceCandidate(candidate)).catch(e => console.error('ICE error:', e));
                        } catch (e) {
                            console.error('Error parsing ICE candidate:', e);
                        }
                    }
                });

                // Listen for when other user ends the call
                db.ref('calls/' + callId + '/ended').on('value', (snap) => {
                    if (snap.val() && callInProgress) {
                        endCall();
                        showToast('Call ended by other user', 'info');
                    }
                });

                // Timeout after 30 seconds
                setTimeout(() => {
                    if (!answered && callInProgress) {
                        endCall();
                        showToast('Call not answered', 'info');
                    }
                }, 30000);

            } catch (err) {
                callInProgress = false;
                $('inCallOverlay').classList.remove('show');
                showToast('Failed to start call: ' + err.message, 'info');
            }
        }

        async function createOffer(callId) {
            peerConnection = new RTCPeerConnection(ICE_SERVERS);

            if (localStream) {
                localStream.getTracks().forEach(track => peerConnection.addTrack(track, localStream));
            }

            peerConnection.onicecandidate = (event) => {
                if (event.candidate) {
                    db.ref('calls/' + callId + '/iceCandidates/' + currentUser.uid).push(JSON.stringify(event.candidate));
                }
            };

            peerConnection.ontrack = (event) => {
                console.log('Received remote track:', event.track.kind);
            };

            const offer = await peerConnection.createOffer();
            await peerConnection.setLocalDescription(offer);
            return offer;
        }

        async function acceptCall() {
            if (!incomingCallData) return;
            try {
                $('incomingCallModal').classList.remove('show');
                callInProgress = true;

                // Ensure chat panel is completely hidden
                const chatPanel = $('chatPanel');
                const chatsPanel = $('chatsPanel');
                if (chatPanel) chatPanel.classList.remove('active');
                if (chatsPanel) chatsPanel.style.display = 'none';

                localStream = await navigator.mediaDevices.getUserMedia({ audio: true, video: false });

                const offer = JSON.parse(incomingCallData.offer);
                peerConnection = new RTCPeerConnection(ICE_SERVERS);

                localStream.getTracks().forEach(track => peerConnection.addTrack(track, localStream));

                peerConnection.onicecandidate = (event) => {
                    if (event.candidate) {
                        db.ref('calls/' + incomingCallData.callId + '/iceCandidates/' + currentUser.uid).push(JSON.stringify(event.candidate));
                    }
                };

                peerConnection.ontrack = (event) => {
                    console.log('Received remote track:', event.track.kind);
                };

                // Set caller info on call screen first
                const callerName = friendNames[incomingCallData.caller] || 'User';
                $('callUserName').textContent = callerName;
                activeFriendUid = incomingCallData.caller;

                // Show call screen full screen
                $('inCallOverlay').classList.add('show');
                $('callStatus').textContent = 'Connecting...';

                await peerConnection.setRemoteDescription(new RTCSessionDescription(offer));
                const answer = await peerConnection.createAnswer();
                await peerConnection.setLocalDescription(answer);

                db.ref('calls/' + incomingCallData.callId + '/answer').set(JSON.stringify(answer));

                // Listen for ICE candidates from remote
                db.ref('calls/' + incomingCallData.callId + '/iceCandidates/' + incomingCallData.caller).on('child_added', (snap) => {
                    if (peerConnection && snap.val()) {
                        try {
                            const candidate = JSON.parse(snap.val());
                            peerConnection.addIceCandidate(new RTCIceCandidate(candidate)).catch(e => console.error('ICE error:', e));
                        } catch (e) {
                            console.error('Error parsing ICE candidate:', e);
                        }
                    }
                });

                // Start call with duration tracking
                startCall(incomingCallData.callId);
                showToast('Call accepted', 'success', 1200);
            } catch (err) {
                callInProgress = false;
                $('inCallOverlay').classList.remove('show');
                showToast('Failed to accept call: ' + err.message, 'info');
            }
        }

        function rejectCall() {
            if (incomingCallData) {
                db.ref('calls/' + incomingCallData.callId + '/status').set('rejected');
                processedCallIds.delete(incomingCallData.callId); // Remove from processed so it can show again if recalled
                incomingCallData = null;
            }
            $('incomingCallModal').classList.remove('show');
        }

        function formatCallDuration(seconds) {
            const hrs = Math.floor(seconds / 3600);
            const mins = Math.floor((seconds % 3600) / 60);
            const secs = seconds % 60;
            if (hrs > 0) return `${hrs}:${String(mins).padStart(2, '0')}:${String(secs).padStart(2, '0')}`;
            return `${mins}:${String(secs).padStart(2, '0')}`;
        }

        function updateCallDuration() {
            if (!callStartTime) return;
            const elapsed = Math.floor((Date.now() - callStartTime) / 1000);
            $('callStatus').textContent = formatCallDuration(elapsed);
        }

        function startCall(callId) {
            inCall = true;
            callStartTime = Date.now();
            currentCallId = callId;
            $('inCallOverlay').classList.add('show');
            $('callStatus').textContent = '0:00';

            // Update call duration every second
            if (callDurationInterval) clearInterval(callDurationInterval);
            callDurationInterval = setInterval(updateCallDuration, 1000);

            // Update call screen with user info
            if (activeFriendUid) {
                const friendName = friendNames[activeFriendUid] || 'User';
                $('callUserName').textContent = friendName;
                $('callUserAvatar').src = 'https://img.freepik.com/free-vector/cute-parrot-bird-branch-cartoon-vector-icon-illustration-animal-nature-icon-isolated-flat-vector_138676-14867.jpg?w=740&q=80';
            }

            const video = $('localVideo');
            if (localStream && video) {
                video.srcObject = localStream;
                video.style.display = 'block';
            }
        }

        function toggleMute() {
            if (!localStream) return;
            const muteBtn = $('muteBtn');
            const audioTracks = localStream.getAudioTracks();
            audioTracks.forEach(track => track.enabled = !track.enabled);
            muteBtn.textContent = audioTracks[0]?.enabled ? 'üîä' : 'üîá';
        }

        function endCall() {
            inCall = false;
            callInProgress = false;

            // Clear duration interval
            if (callDurationInterval) {
                clearInterval(callDurationInterval);
                callDurationInterval = null;
            }

            // Notify other user that call ended
            if (currentCallId) {
                db.ref('calls/' + currentCallId + '/ended').set(true);
            }

            if (localStream) {
                localStream.getTracks().forEach(track => track.stop());
                localStream = null;
            }

            if (peerConnection) {
                peerConnection.close();
                peerConnection = null;
            }

            $('inCallOverlay').classList.remove('show');
            $('localVideo').style.display = 'none';
            $('muteBtn').textContent = 'üîä';
            callStartTime = null;
            currentCallId = null;
            showToast('Call ended', 'info');
        }

        // Listen for incoming calls
        function listenForIncomingCalls() {
            if (!currentUser) return;
            db.ref('calls').orderByChild('callee').equalTo(currentUser.uid).on('child_added', (snap) => {
                const callData = snap.val();
                const callId = snap.key;

                // Only show calls that are ringing, not already processed, and not more than 2 minutes old
                if (callData.status === 'ringing' && !inCall && !callInProgress &&
                    !processedCallIds.has(callId) && (Date.now() - callData.timestamp) < 120000) {

                    processedCallIds.add(callId);
                    incomingCallData = { callId: callId, ...callData };
                    const callerName = friendNames[callData.caller] || 'User';
                    $('incomingCallerName').textContent = callerName + ' is calling...';
                    $('incomingCallModal').classList.add('show');
                    sendNotification(callerName + ' is calling', { body: 'Tap to answer' });
                }
            });
        }

        /* Toast */
        function showToast(msg, type = 'info', ms = 2200) {
            const holder = $('toastHolder');
            const t = document.createElement('div');
            t.className = 'toast ' + (type === 'success' ? 'success' : 'info');
            t.textContent = msg;
            holder.appendChild(t);
            setTimeout(() => t.classList.add('show'), 10);
            setTimeout(() => { t.classList.remove('show'); setTimeout(() => t.remove(), 320); }, ms);
        }

        /* Auth UI toggles */
        $('showLoginBtn').addEventListener('click', () => {
            show($('loginForm')); hide($('signupForm'));
            $('showLoginBtn').style.background = 'var(--wh-green)';
            $('showSignupBtn').style.background = 'white';
        });
        $('showSignupBtn').addEventListener('click', () => {
            show($('signupForm')); hide($('loginForm'));
            $('showSignupBtn').style.background = 'var(--wh-green)';
            $('showLoginBtn').style.background = 'white';
        });
        function clearLogin() { $('loginEmail').value = ''; $('loginPass').value = ''; }
        function cancelSignup() { show($('loginForm')); hide($('signupForm')); }

        /* Auth actions */
        function signup() {
            const name = $('signupName').value.trim();
            const email = $('signupEmail').value.trim();
            const pass = $('signupPass').value;
            $('signupErr').textContent = '';
            if (!name || !email || !pass) { $('signupErr').textContent = 'Fill all fields'; return; }

            auth.createUserWithEmailAndPassword(email, pass)
                .then(uc => {
                    currentUser = uc.user;
                    db.ref('users/' + currentUser.uid).set({ name, email, online: true });
                    hide($('authModal'));
                    initAfterAuth();
                    showToast('Account created', 'success');
                })
                .catch(err => { $('signupErr').textContent = err.message; });
        }

        function login() {
            const email = $('loginEmail').value.trim();
            const pass = $('loginPass').value;
            $('loginErr').textContent = '';
            if (!email || !pass) { $('loginErr').textContent = 'Fill email & password'; return; }

            auth.signInWithEmailAndPassword(email, pass)
                .then(uc => {
                    currentUser = uc.user;
                    db.ref('users/' + currentUser.uid).update({ online: true });
                    hide($('authModal'));
                    initAfterAuth();
                    showToast('Login successful', 'success');
                })
                .catch(err => { $('loginErr').textContent = err.message; });
        }

        function logoutFromModal() {
            if (!currentUser) return closeMoreModal();
            db.ref('users/' + currentUser.uid + '/online').set(false);
            auth.signOut().then(() => {
                currentUser = null;
                $('chatList').innerHTML = '';
                $('chatBody').innerHTML = '';
                $('chatName').textContent = 'Select a chat';
                show($('authModal'));
                closeMoreModal();
                showToast('Logged out', 'info');
            });
        }
        function switchAccountModal() { logoutFromModal(); }
        function closeMoreModal() { hide($('moreModal')); }

        /* Auth state */
        auth.onAuthStateChanged(user => {
            if (user) {
                currentUser = user;
                db.ref('users/' + currentUser.uid).update({ online: true });
                hide($('authModal'));
                hide($('moreModal'));
                hide($('addFriendModal'));
                hide($('settingsModal'));
                initAfterAuth();
            } else {
                hide($('addFriendModal'));
                hide($('settingsModal'));
                hide($('moreModal'));
                show($('authModal'));
            }
        });

        /* After auth */
        function initAfterAuth() {
            requestNotificationPermission();
            listenForIncomingCalls();
            openChats();
            loadChatsList();
            // Hide splash screen after app initializes
            setTimeout(() => {
                const splash = $('splashScreen');
                splash.classList.add('hidden');
            }, 1500);
            showToast('Welcome back', 'success', 1200);
        }

        /* Panel toggles */
        function openChats() {
            const chatPanel = $('chatPanel');
            const chatsPanel = $('chatsPanel');
            // Always show chats list, hide chat panel
            if (chatPanel) chatPanel.classList.remove('active');
            if (chatsPanel) chatsPanel.style.display = 'flex';
        }

        function openMore() {
            show($('moreModal'));
        }

        /* Load chats list (dedupe) */
        function loadChatsList() {
            const list = $('chatList');
            list.innerHTML = '';

            db.ref('friends/' + currentUser.uid).once('value').then(snapshot => {
                const friends = snapshot.val();
                if (!friends) {
                    list.innerHTML = '<div style="padding:16px;color:#666">No friends yet ‚Äî use ADD FRIEND</div>';
                    return;
                }
                // friends is an object of friendUid:true
                const friendUids = Object.keys(friends);
                // fetch all friend user records in parallel
                const userPromises = friendUids.map(uid => db.ref('users/' + uid).once('value').then(s => ({ uid, data: s.val() })));
                Promise.all(userPromises).then(results => {
                    // build items in stable order
                    results.forEach(res => {
                        const friendUid = res.uid;
                        const user = res.data || { name: 'Unknown', avatar: '' };
                        friendNames[friendUid] = user.name || 'User'; // cache friend name
                        const chatId = [currentUser.uid, friendUid].sort().join('_');

                        // get last message & unread count
                        db.ref('messages/' + chatId).orderByChild('timestamp').limitToLast(1).once('value').then(msgSnap => {
                            let lastText = '', lastTime = '';
                            msgSnap.forEach(m => {
                                lastText = m.val().text;
                                let d = new Date(m.val().timestamp);
                                lastTime = d.getHours() + ':' + String(d.getMinutes()).padStart(2, '0');
                            });

                            db.ref('messages/' + chatId).once('value').then(allSnap => {
                                let unreadCount = 0;
                                allSnap.forEach(m => {
                                    const msg = m.val();
                                    if (msg.sender === friendUid && !msg.seen) unreadCount++;
                                });

                                const item = document.createElement('div');
                                item.className = 'chat-item';
                                item.innerHTML = `
              <div class="avatar"><img src="https://img.freepik.com/free-vector/cute-parrot-bird-branch-cartoon-vector-icon-illustration-animal-nature-icon-isolated-flat-vector_138676-14867.jpg?w=740&q=80" style="width:100%;height:100%;object-fit:cover;border-radius:50%"></div>
              <div class="chat-meta">
                <div class="head"><div class="name">${escapeHtml(user.name || 'User')}</div><div class="time-badge">${lastTime || ''}</div></div>
                <div style="display:flex;align-items:center;gap:8px">
                  <div class="preview">${escapeHtml(lastText || '')}</div>
                  ${unreadCount > 0 ? `<div class="unread-badge">${unreadCount}</div>` : ''}
                </div>
              </div>
            `;
                                // stable closure: addEventListener with friendUid copy
                                item.addEventListener('click', (function (uidCopy, nameCopy) {
                                    return function () {
                                        openChatWith(uidCopy, nameCopy);
                                    };
                                })(friendUid, user.name));
                                list.appendChild(item);
                            });
                        });
                    });
                });
            });
        }

        /* Search filter */
        function filterChats() {
            const q = $('searchInput').value.trim().toLowerCase();
            document.querySelectorAll('.chat-item').forEach(el => {
                el.style.display = el.textContent.toLowerCase().includes(q) ? '' : 'none';
            });
        }

        /* Add friend */
        function openAddFriendModal() { $('addFriendErr').textContent = ''; $('addFriendEmail').value = ''; show($('addFriendModal')); }
        function closeAddFriendModal() { hide($('addFriendModal')); }
        function addFriendFromModal() {
            const email = $('addFriendEmail').value.trim();
            $('addFriendErr').textContent = '';
            if (!email) { $('addFriendErr').textContent = 'Type an email'; return; }
            db.ref('users').orderByChild('email').equalTo(email).once('value').then(snap => {
                const users = snap.val();
                if (!users) { $('addFriendErr').textContent = 'User not found'; return; }
                const friendUid = Object.keys(users)[0];
                if (friendUid === currentUser.uid) { $('addFriendErr').textContent = "You can't add yourself"; return; }
                const updates = {};
                updates['/friends/' + currentUser.uid + '/' + friendUid] = true;
                updates['/friends/' + friendUid + '/' + currentUser.uid] = true;
                db.ref().update(updates).then(() => {
                    closeAddFriendModal();
                    showToast('Friend added', 'success');
                    loadChatsList();
                }).catch(e => {
                    $('addFriendErr').textContent = 'Failed to add friend';
                });
            }).catch(err => { $('addFriendErr').textContent = 'Error checking user'; });
        }

        /* Chat open/send/receive */
        function openChatWith(friendUid, friendName) {
            activeFriendUid = friendUid;
            activeChatId = [currentUser.uid, friendUid].sort().join('_');

            // UI adjustments: show chat panel, hide chats list, show back button
            const chatPanel = $('chatPanel');
            const chatsPanel = $('chatsPanel');
            if (chatPanel) {
                chatPanel.classList.add('active');
            }
            if (chatsPanel) chatsPanel.style.display = 'none';
            $('backBtn').style.display = '';

            $('chatName').textContent = friendName || 'Chat';
            $('chatAvatar').src = 'https://img.freepik.com/free-vector/cute-parrot-bird-branch-cartoon-vector-icon-illustration-animal-nature-icon-isolated-flat-vector_138676-14867.jpg?w=740&q=80';

            // online status
            db.ref('users/' + friendUid + '/online').on('value', snap => {
                const v = snap.val();
                $('chatStatus').textContent = v ? '‚óè Online' : '‚óã Offline';
            });

            // messages: clear previous, set listener
            const chatBody = $('chatBody'); chatBody.innerHTML = '';
            const ref = db.ref('messages/' + activeChatId);
            ref.off();
            ref.on('child_added', snap => {
                const msg = snap.val();
                const key = snap.key;
                appendMessage(msg, key);
                if (msg.sender !== currentUser.uid && !msg.seen) {
                    db.ref('messages/' + activeChatId + '/' + key + '/seen').set(true);
                    // Send notification for incoming message
                    const friendName = friendNames[msg.sender] || 'Someone';
                    sendNotification(friendName + ' sent a message', {
                        body: msg.text.substring(0, 100),
                        tag: 'message-' + msg.sender,
                        requireInteraction: false
                    });
                }
            });

            // typing indicator: show simple "typing..." bubble (friend side)
            db.ref('typing/' + activeChatId + '/' + friendUid).on('value', s => {
                const val = s.val();
                removeTypingElem();
                if (val) {
                    const t = document.createElement('div'); t.className = 'typing'; t.id = 'typingElem'; t.textContent = (friendName || 'Friend') + ' is typing...';
                    chatBody.appendChild(t);
                    chatBody.scrollTop = chatBody.scrollHeight;
                }
            });
        }

        function backToChats() {
            const chatPanel = $('chatPanel');
            const chatsPanel = $('chatsPanel');
            if (chatsPanel) chatsPanel.style.display = 'flex';
            if (chatPanel) chatPanel.classList.remove('active');
            $('backBtn').style.display = 'none';
            activeChatId = null;
            activeFriendUid = null;
            $('chatBody').innerHTML = '';
            $('chatName').textContent = 'Select a chat';
        }

        function appendMessage(msg, key) {
            const chatBody = $('chatBody');
            const div = document.createElement('div');
            div.className = 'bubble ' + (msg.sender === currentUser.uid ? 'sent' : 'recv');
            const time = new Date(msg.timestamp || Date.now());
            const hh = time.getHours(), mm = String(time.getMinutes()).padStart(2, '0');
            const safeText = escapeHtml(msg.text || '');
            div.innerHTML = `<div>${safeText}</div><div class="time">${hh}:${mm}${msg.sender === currentUser.uid ? ` <span class="ticks">${msg.seen ? '‚úì‚úì' : '‚úì'}</span>` : ''}</div>`;
            chatBody.appendChild(div);
            chatBody.scrollTop = chatBody.scrollHeight;
        }

        function removeTypingElem() { const t = $('typingElem'); if (t) t.remove(); }

        function sendMessage() {
            if (!activeChatId || !activeFriendUid) { showToast('Select a chat first', 'info'); return; }
            const txt = $('messageInput').value.trim();
            if (!txt) return;
            const ref = db.ref('messages/' + activeChatId).push();
            ref.set({ text: txt, sender: currentUser.uid, timestamp: Date.now(), seen: false })
                .then(() => {
                    $('messageInput').value = '';
                    showToast('Message sent', 'success', 900);
                }).catch(() => showToast('Failed to send', 'info'));
        }

        /* typing */
        function typing(isTyping) {
            if (!activeChatId) return;
            db.ref('typing/' + activeChatId + '/' + currentUser.uid).set(isTyping);
            if (typingTimer) clearTimeout(typingTimer);
            if (isTyping) {
                typingTimer = setTimeout(() => {
                    db.ref('typing/' + activeChatId + '/' + currentUser.uid).set(false);
                }, 1800);
            }
        }

        /* cleanup */
        window.addEventListener('beforeunload', () => { if (currentUser) db.ref('users/' + currentUser.uid + '/online').set(false); });

        /* Settings (no upload): change display name only */
        function openSettingsModal() { $('settingsMsg').textContent = ''; $('changeNameInput').value = ''; show($('settingsModal')); }
        function closeSettingsModal() { hide($('settingsModal')); }
        function updateDisplayName() {
            const v = $('changeNameInput').value.trim();
            if (!v) { $('settingsMsg').textContent = 'Type a name'; return; }
            db.ref('users/' + currentUser.uid + '/name').set(v).then(() => {
                showToast('Name updated', 'success');
                closeSettingsModal();
                loadChatsList();
            }).catch(() => $('settingsMsg').textContent = 'Failed to update');
        }
        /* More modal wrappers */
        function closeMoreModal() { hide($('moreModal')); }

        /* small helpers */
        function escapeHtml(s) { if (!s) return ''; return s.replaceAll('&', '&amp;').replaceAll('<', '&lt;').replaceAll('>', '&gt;'); }

        /* initial state */
        if (auth.currentUser) hide($('authModal'));
    </script>
</body>

</html>